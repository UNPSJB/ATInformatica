{% extends 'principal.html' %} 
{% load staticfiles %} 
{% block estilos %}
<!-- Animate.css -->
<link href="{% static 'vendors/animate.css/animate.min.css' %}" rel="stylesheet">

{% endblock estilos %} 
{% block contenido %}
<div class="row x_panel">

  <div class="col-md-4">
    <p class="lead">Permisos</p>
    <ul id="draggable" style="list-style:none">
      {% for permiso in permisos %}
        <li data-tipo="permiso" data-grupo="{{ grupo.id }}" data-permiso="{{ permiso.id }}" data-ajax="{url 'usuario:grupo_add_permiso'}"><span class="btn btn-default">{{ permiso.name }}</span></li>
      {% empty %}
        <h1>No hay permisos </h1>
      {% endfor %} 
    </ul>
  </div>
  <div class="col-md-4">
      <div class="x_content">
  
        <!-- start accordion -->
        <div class="accordion" id="accordion" role="tab" aria-multiselectable="true">
          <p class="lead">Grupos<p>
          {% for grupo in grupos %}
          <div class="panel">
            <a class="panel-heading" role="tab" id="heading{{grupo.id}}" data-toggle="collapse" data-parent="#accordion" href="#collapse_{{grupo.id}}" aria-expanded="true"
              aria-controls="collapse_{{grupo.id}}">
              <h4 class="panel-title">{{ grupo.name }}</h4>
            </a>
            <div id="collapse_{{grupo.id}}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading{{grupo.id}}">
              <div class="panel-body">
                  <h5>Permisos</h5>
                  <div class="panel-body">

                    {% comment %} aca tenemos que mostrar los permisos 
                    que tiene asignado el grupo {% endcomment %}
                    
                    {% for permiso in grupo.permissions.all %}
                      <p>{{ permiso.name }}</p>
                    {% empty %}
                    <span>no hay cosos</span>
                    {% endfor %}
                  </div>
              </div>
              <div class="panel-body">
                  <h5>Usuarios</h5>
                  <div class="panel-body">

                    {% comment %} aca tenemos que mostra los usuarios 
                    que tiene asignado el grupo {% endcomment %}
                    
                     {% for usuario in grupo.user_set.all %} 
                        <p>{{ usuario.username }}</p>
                     {% empty %} 
                        <span>aca tampoco hay cosos</span>
                     {% endfor %}
                  </div>
              </div>
            </div>
          </div>
          {% empty %}
            <h1>No hay grupos </h1>
          {% endfor %}
        </div>
        <button style="float:right" class="btn btn-primary" data-toggle="modal" data-target="#modalGrupo">Crear grupo</button>
        {% include "modal-add-grupo.html" %}
        <!-- end of accordion -->
  
  
      </div>
    </div>
  <div class="col-md-4">
    <p class="lead">Usuarios</p>
    <ul id="draggable" style="list-style:none">
      {% for usuario in usuarios %}
        <li data-tipo="usuario" data-grupo="{{ grupo.id }}" data-usuario="{{ usuario.id }}" data-ajax="{url 'usuario:usuario_add_grupo'}"><span  class="btn btn-default">{{ usuario.username }}</span></li>
      {% empty %}
        <h1>No hay usuarios </h1>
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock contenido %} 

{% block scripts %}
<!-- prueba jquery ui -->
<script>
  $( function() {
    $( "#draggable li" ).draggable({ revert: true, helper: "clone", });
    {% for grupo in grupos %}
      $("#collapse_{{grupo.id}}").droppable({
        drop: function (event, ui) {
          var tipo = ui.draggable[0].dataset['tipo']
          var item = ui.draggable[0].innerText
          
          if (tipo == "permiso") {
            var permiso_id = ui.draggable[0].dataset['permiso']
            var ajaxurl = 'add_permiso'
            data = {
              'permiso_id' : permiso_id,
              'grupo_id' : {{grupo.id}}
            }
          }
          if (tipo == "usuario") {
            var usuario_id = ui.draggable[0].dataset['usuario']
            var ajaxurl = 'add_grupo'
            data = {
              'usuario_id': usuario_id,
              'grupo_id': {{grupo.id}}
            }
          }

          console.log(data)
          console.log('Se drope√≥ el '+tipo+' de nombre \"'+item+'\" en el grupo {{grupo.id}}')
        
          $.ajax({    
            url: ajaxurl,
            type: "POST",
            data: data,
            dataType: 'json',
            success: function(data){
                alert("Todo piola");
                location.reload()    
            },
            statusCode: {
                403: function(data) {
                    // Mensaje del servidor
                    alert("todo mal");
                }
            }
        });

        }
      })
    {% endfor %}
  });
</script>
<script src="{% static '/js/crear_grupo.js' %}"></script>
{% endblock scripts %}